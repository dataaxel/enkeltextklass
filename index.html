<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Filmomd√∂me-klassificerare</title>

  <style>
    :root{
      --bg:#6b6fd6;
      --card:#ffffff;
      --muted:#6b7280;
      --danger:#b91c1c;
      --danger-bg:#fee2e2;
      --ok:#065f46;
      --ok-bg:#d1fae5;
      --border:#e5e7eb;
      --btn:#111827;
      --btn2:#374151;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      background: var(--bg);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .card{
      width:min(760px, 100%);
      background:var(--card);
      border-radius:18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      padding:28px;
    }
    h1{
      margin:0 0 6px 0;
      font-size:28px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .sub{
      margin:0 0 18px 0;
      color:var(--muted);
      font-size:14px;
    }
    .alert{
      display:none;
      border-radius:12px;
      padding:12px 14px;
      margin: 10px 0 16px 0;
      border:1px solid rgba(0,0,0,.05);
      font-size:14px;
      line-height:1.35;
      white-space: pre-wrap;
    }
    .alert.danger{ background: var(--danger-bg); color: var(--danger); }
    .alert.ok{ background: var(--ok-bg); color: var(--ok); }
    label{ font-weight:700; display:block; margin:12px 0 8px; }
    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px;
      font-size:15px;
      outline:none;
    }
    textarea:focus{ border-color:#9ca3af; box-shadow: 0 0 0 4px rgba(156,163,175,.25); }
    .row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:0;
      border-radius:12px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      color:#fff;
      background:var(--btn);
    }
    button.secondary{ background:var(--btn2); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .result{
      margin-top:14px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#f9fafb;
      display:none;
    }
    .result strong{ font-size:16px; }
    .pill-row{
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid var(--border);
    }
    .pill{
      border:1px solid var(--border);
      background:#fff;
      color:#111827;
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:700;
    }
    .tiny{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }
    code.small{
      font-size:12px;
      background:#f3f4f6;
      padding:2px 6px;
      border-radius:8px;
    }
  </style>

  <!-- VIKTIGT: TFJS-version som matchar nyare converter-format -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
</head>

<body>
  <div class="card">
    <h1>üé¨ AI Filmomd√∂me-klassificerare</h1>
    <p class="sub">Skriv ett omd√∂me och l√•t AI:n avg√∂ra om det √§r positivt, negativt eller neutralt.</p>

    <div id="alert" class="alert danger"></div>
    <div id="ok" class="alert ok"></div>

    <label for="text">Ditt filmomd√∂me:</label>
    <textarea id="text" placeholder="Skriv ditt omd√∂me h√§r‚Ä¶ Till exempel: 'Fantastisk film med otroliga effekter!'"></textarea>

    <div class="row">
      <button id="btnAnalyze" onclick="analyze()" disabled>Analysera k√§nsla</button>
      <button class="secondary" onclick="reloadModel()">Ladda om modellen</button>
      <span class="tiny">Modell: <code class="small">./tfjs_model/model.json</code></span>
    </div>

    <div id="result" class="result"></div>

    <div class="pill-row">
      <div style="font-weight:800; margin-bottom:10px;">üí° Prova dessa exempel:</div>
      <div class="row">
        <button class="pill" onclick="setExample('Det h√§r var en fantastisk film, jag √§lskade den!')">Positiv</button>
        <button class="pill" onclick="setExample('Riktigt d√•lig film, sl√∂seri med tid.')">Negativ</button>
        <button class="pill" onclick="setExample('Filmen var okej, varken bra eller d√•lig.')">Neutral</button>
      </div>
    </div>

    <div class="tiny" id="debug"></div>
  </div>

<script>
  // --- Filv√§gar (matchar repo-strukturen /tfjs_model/* ) ---
  const MODEL_URL = './tfjs_model/model.json';
  const TOKENIZER_URL = './tfjs_model/tokenizer.json';

  let model = null;
  let tokenizer = null;

  const els = {
    alert: document.getElementById('alert'),
    ok: document.getElementById('ok'),
    text: document.getElementById('text'),
    btn: document.getElementById('btnAnalyze'),
    result: document.getElementById('result'),
    debug: document.getElementById('debug')
  };

  function showError(msg) {
    els.alert.style.display = 'block';
    els.ok.style.display = 'none';
    els.alert.textContent = '‚úñ Fel: ' + msg;
  }
  function showOk(msg) {
    els.ok.style.display = 'block';
    els.alert.style.display = 'none';
    els.ok.textContent = '‚úî ' + msg;
  }
  function clearMessages() {
    els.alert.style.display = 'none';
    els.ok.style.display = 'none';
    els.alert.textContent = '';
    els.ok.textContent = '';
  }
  function setAnalyzeEnabled(enabled) {
    els.btn.disabled = !enabled;
  }

  // --- Tokenisering helpers ---
  function normalizeText(s) {
    return (s || '')
      .toLowerCase()
      .replace(/[^a-z√•√§√∂0-9\s]+/gi, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function getWordIndex(tokObj) {
    return tokObj?.word_index || tokObj?.wordIndex || tokObj?.config?.word_index || tokObj?.config?.wordIndex || null;
  }

  function getMaxLen(tokObj) {
    const v = tokObj?.max_length ?? tokObj?.maxLen ?? tokObj?.config?.max_length ?? tokObj?.config?.maxLen;
    const n = Number(v);
    return Number.isFinite(n) && n > 0 ? n : 20;
  }

  function getOOVIndex(tokObj, wordIndex) {
    const direct = tokObj?.oov_index ?? tokObj?.oovIndex ?? tokObj?.config?.oov_index ?? tokObj?.config?.oovIndex;
    const n = Number(direct);
    if (Number.isFinite(n) && n >= 0) return n;

    const oovToken = tokObj?.oov_token ?? tokObj?.oovToken ?? tokObj?.config?.oov_token ?? tokObj?.config?.oovToken;
    if (oovToken && wordIndex && wordIndex[oovToken] != null) return wordIndex[oovToken];

    if (wordIndex && wordIndex['<OOV>'] != null) return wordIndex['<OOV>'];

    return 1;
  }

  function textToPaddedSequence(text) {
    if (!tokenizer) throw new Error('Tokenizer saknas.');
    const wordIndex = getWordIndex(tokenizer);
    if (!wordIndex) throw new Error('Kunde inte hitta word_index i tokenizer.json.');

    const maxLen = getMaxLen(tokenizer);
    const oovIndex = getOOVIndex(tokenizer, wordIndex);

    const cleaned = normalizeText(text);
    const words = cleaned ? cleaned.split(' ') : [];
    const seq = words.map(w => (wordIndex[w] != null ? wordIndex[w] : oovIndex));

    // Pre-padding med 0, trunkera fr√•n v√§nster
    const padded = new Array(maxLen).fill(0);
    const cut = seq.slice(-maxLen);
    for (let i = 0; i < cut.length; i++) {
      padded[maxLen - cut.length + i] = cut[i];
    }
    return { padded, maxLen };
  }

  // --- Ladda modell + tokenizer ---
  async function loadAll() {
    clearMessages();
    setAnalyzeEnabled(false);
    els.result.style.display = 'none';
    els.debug.textContent = '';

    try {
      // Cache-bypass (GitHub Pages kan cachea h√•rt)
      const r = await fetch(MODEL_URL, { cache: 'no-store' });
      if (!r.ok) throw new Error(`Hittar inte model.json (${r.status}). Kontrollera s√∂kv√§gen: ${MODEL_URL}`);

      const tr = await fetch(TOKENIZER_URL, { cache: 'no-store' });
      if (!tr.ok) throw new Error(`Hittar inte tokenizer.json (${tr.status}). Kontrollera s√∂kv√§gen: ${TOKENIZER_URL}`);

      // Backend
      await tf.setBackend('webgl');
      await tf.ready();

      tokenizer = await tr.json();

      // Ladda modellen (om detta kraschar √§r model.json fel eller TFJS-version mismatch)
      model = await tf.loadLayersModel(MODEL_URL);

      const inShape = model?.inputs?.[0]?.shape ? JSON.stringify(model.inputs[0].shape) : '(ok√§nd)';
      const outShape = model?.outputs?.[0]?.shape ? JSON.stringify(model.outputs[0].shape) : '(ok√§nd)';

      showOk(`Modellen √§r laddad. TFJS ${tf.version.tfjs}. Input: ${inShape}, Output: ${outShape}`);
      els.debug.textContent = `Debug: TFJS ${tf.version.tfjs} | modelUrl=${MODEL_URL} | tokenizerUrl=${TOKENIZER_URL}`;
      setAnalyzeEnabled(true);
    } catch (err) {
      console.error(err);
      showError(err?.message || String(err));
      model = null;
      tokenizer = null;
      setAnalyzeEnabled(false);
    }
  }

  async function reloadModel() {
    try { if (model?.dispose) model.dispose(); } catch {}
    model = null;
    tokenizer = null;
    await loadAll();
  }

  // --- Tolka output ---
  function labelFromScores(arr) {
    // Vanlig softmax-3: [neg, neu, pos]
    if (arr.length === 3) {
      let best = 0;
      for (let i = 1; i < 3; i++) if (arr[i] > arr[best]) best = i;
      return { label: ['Negativ', 'Neutral', 'Positiv'][best], scores: arr };
    }

    // Tv√• klasser: antag [neg, pos]
    if (arr.length === 2) {
      return { label: (arr[1] >= arr[0]) ? 'Positiv' : 'Negativ', scores: arr };
    }

    // En output (sigmoid): thresholda
    if (arr.length === 1) {
      const p = arr[0];
      if (p >= 0.6) return { label: 'Positiv', scores: [p] };
      if (p <= 0.4) return { label: 'Negativ', scores: [p] };
      return { label: 'Neutral', scores: [p] };
    }

    // fallback argmax
    let best = 0;
    for (let i = 1; i < arr.length; i++) if (arr[i] > arr[best]) best = i;
    return { label: `Klass ${best}`, scores: arr };
  }

  // --- Prediktion ---
  async function analyze() {
    clearMessages();
    els.result.style.display = 'none';

    const text = els.text.value.trim();
    if (!text) return showError('Skriv ett omd√∂me f√∂rst.');
    if (!model || !tokenizer) return showError('Modell/tokenizer √§r inte laddad. Klicka ‚ÄúLadda om modellen‚Äù.');

    try {
      const { padded, maxLen } = textToPaddedSequence(text);

      // VIKTIGT: int32 input till Embedding-modell
      const inputTensor = tf.tensor2d([padded], [1, maxLen], 'int32');

      const out = model.predict(inputTensor);
      const data = await out.data();

      // st√§da minne
      inputTensor.dispose();
      if (out?.dispose) out.dispose();

      const arr = Array.from(data);
      const { label, scores } = labelFromScores(arr);

      els.result.style.display = 'block';
      els.result.innerHTML =
        `<strong>Resultat: ${label}</strong>
         <div style="margin-top:8px;color:#374151;">
           Scores: ${scores.map(x => (typeof x === 'number' ? x.toFixed(4) : x)).join(', ')}
         </div>`;
    } catch (err) {
      console.error(err);
      showError(err?.message || String(err));
    }
  }

  function setExample(s) {
    els.text.value = s;
    els.text.focus();
  }

  // Start
  loadAll();
</script>
</body>
</html>

