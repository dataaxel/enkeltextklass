<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Filmomd√∂me-klassificerare</title>

  <style>
    :root{
      --bg:#6b6fd6;
      --card:#ffffff;
      --muted:#6b7280;
      --danger:#b91c1c;
      --danger-bg:#fee2e2;
      --ok:#065f46;
      --ok-bg:#d1fae5;
      --border:#e5e7eb;
      --btn:#111827;
      --btn2:#374151;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      background: var(--bg);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .card{
      width:min(860px, 100%);
      background:var(--card);
      border-radius:18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      padding:28px;
    }
    h1{
      margin:0 0 6px 0;
      font-size:28px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .sub{
      margin:0 0 18px 0;
      color:var(--muted);
      font-size:14px;
    }
    .alert{
      display:none;
      border-radius:12px;
      padding:12px 14px;
      margin: 10px 0 16px 0;
      border:1px solid rgba(0,0,0,.05);
      font-size:14px;
      line-height:1.35;
      white-space: pre-wrap;
    }
    .alert.danger{ background: var(--danger-bg); color: var(--danger); }
    .alert.ok{ background: var(--ok-bg); color: var(--ok); }

    label{ font-weight:800; display:block; margin:12px 0 8px; }
    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px;
      font-size:15px;
      outline:none;
    }
    textarea:focus{ border-color:#9ca3af; box-shadow: 0 0 0 4px rgba(156,163,175,.25); }

    .row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:0;
      border-radius:12px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      color:#fff;
      background:var(--btn);
    }
    button.secondary{ background:var(--btn2); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .result{
      margin-top:14px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#f9fafb;
      display:none;
    }

    .pill-row{
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid var(--border);
    }
    .pill{
      border:1px solid var(--border);
      background:#fff;
      color:#111827;
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:800;
    }

    details{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#f9fafb;
      padding:10px 12px;
    }
    summary{
      cursor:pointer;
      font-weight:900;
    }
    pre{
      margin:10px 0 0 0;
      font-size:12px;
      line-height:1.35;
      background:#111827;
      color:#e5e7eb;
      padding:12px;
      border-radius:12px;
      overflow:auto;
      max-height:240px;
    }

    .tiny{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }
    code.small{
      font-size:12px;
      background:#f3f4f6;
      padding:2px 6px;
      border-radius:8px;
    }
  </style>

  <!-- VIKTIGT: ny TFJS-version -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
</head>

<body>
  <div class="card">
    <h1>üé¨ AI Filmomd√∂me-klassificerare</h1>
    <p class="sub">Skriv ett omd√∂me och l√•t AI:n avg√∂ra om det √§r positivt, negativt eller neutralt.</p>

    <div id="alert" class="alert danger"></div>
    <div id="ok" class="alert ok"></div>

    <label for="text">Ditt filmomd√∂me:</label>
    <textarea id="text" placeholder="Skriv ditt omd√∂me h√§r‚Ä¶ Till exempel: 'Fantastisk film med otroliga effekter!'"></textarea>

    <div class="row">
      <button id="btnAnalyze" onclick="analyze()" disabled>Analysera k√§nsla</button>
      <button class="secondary" onclick="reloadModel()">Ladda om modellen</button>
      <span class="tiny">Modell: <code class="small">./tfjs_model/model.json</code></span>
    </div>

    <div id="result" class="result"></div>

    <div class="pill-row">
      <div style="font-weight:900; margin-bottom:10px;">üí° Prova dessa exempel:</div>
      <div class="row">
        <button class="pill" onclick="setExample('Det h√§r var en fantastisk film, jag √§lskade den!')">Positiv</button>
        <button class="pill" onclick="setExample('Riktigt d√•lig film, sl√∂seri med tid.')">Negativ</button>
        <button class="pill" onclick="setExample('Filmen var okej, varken bra eller d√•lig.')">Neutral</button>
      </div>
    </div>

    <details open>
      <summary>üß™ Debug (klicka f√∂r att f√§lla in/ut)</summary>
      <div class="tiny">H√§r ser du exakt vad som laddas (och om model.json har batch_shape eller batch_input_shape).</div>
      <pre id="debug"></pre>
    </details>
  </div>

<script>
  // √ÑNDRA BUILD varje g√•ng du uppdaterar filer i GitHub (tvingar bort cache)
  const BUILD = "2026-01-18-05";

  const MODEL_URL = `./tfjs_model/model.json?v=${BUILD}`;
  const TOKENIZER_URL = `./tfjs_model/tokenizer.json?v=${BUILD}`;

  let model = null;
  let tokenizer = null;

  const els = {
    alert: document.getElementById('alert'),
    ok: document.getElementById('ok'),
    text: document.getElementById('text'),
    btn: document.getElementById('btnAnalyze'),
    result: document.getElementById('result'),
    debug: document.getElementById('debug'),
  };

  function log(line){
    els.debug.textContent += line + "\n";
  }

  function showError(msg) {
    els.alert.style.display = 'block';
    els.ok.style.display = 'none';
    els.alert.textContent = '‚úñ Fel: ' + msg;
  }
  function showOk(msg) {
    els.ok.style.display = 'block';
    els.alert.style.display = 'none';
    els.ok.textContent = '‚úî ' + msg;
  }
  function clearMessages() {
    els.alert.style.display = 'none';
    els.ok.style.display = 'none';
    els.alert.textContent = '';
    els.ok.textContent = '';
  }
  function setAnalyzeEnabled(enabled) {
    els.btn.disabled = !enabled;
  }

  function normalizeText(s) {
    return (s || '')
      .toLowerCase()
      .replace(/[^a-z√•√§√∂0-9\s]+/gi, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function getWordIndex(tokObj) {
    return tokObj?.word_index || tokObj?.wordIndex || tokObj?.config?.word_index || tokObj?.config?.wordIndex || null;
  }
  function getMaxLen(tokObj) {
    const v = tokObj?.max_length ?? tokObj?.maxLen ?? tokObj?.config?.max_length ?? tokObj?.config?.maxLen;
    const n = Number(v);
    return Number.isFinite(n) && n > 0 ? n : 20;
  }
  function getOOVIndex(tokObj, wordIndex) {
    const direct = tokObj?.oov_index ?? tokObj?.oovIndex ?? tokObj?.config?.oov_index ?? tokObj?.config?.oovIndex;
    const n = Number(direct);
    if (Number.isFinite(n) && n >= 0) return n;

    const oovToken = tokObj?.oov_token ?? tokObj?.oovToken ?? tokObj?.config?.oov_token ?? tokObj?.config?.oovToken;
    if (oovToken && wordIndex && wordIndex[oovToken] != null) return wordIndex[oovToken];
    if (wordIndex && wordIndex['<OOV>'] != null) return wordIndex['<OOV>'];
    return 1;
  }

  function textToPaddedSequence(text) {
    if (!tokenizer) throw new Error('Tokenizer saknas.');
    const wordIndex = getWordIndex(tokenizer);
    if (!wordIndex) throw new Error('Kunde inte hitta word_index i tokenizer.json.');

    const maxLen = getMaxLen(tokenizer);
    const oovIndex = getOOVIndex(tokenizer, wordIndex);

    const cleaned = normalizeText(text);
    const words = cleaned ? cleaned.split(' ') : [];
    const seq = words.map(w => (wordIndex[w] != null ? wordIndex[w] : oovIndex));

    const padded = new Array(maxLen).fill(0);
    const cut = seq.slice(-maxLen);
    for (let i = 0; i < cut.length; i++) padded[maxLen - cut.length + i] = cut[i];
    return { padded, maxLen };
  }

  async function fetchText(url){
    const r = await fetch(url, { cache: "no-store" });
    return { status: r.status, ok: r.ok, text: await r.text() };
  }

  function inspectModelJsonText(txt){
    const hasBatchShape = txt.includes('"batch_shape"') || txt.includes("batch_shape");
    const hasBatchInputShape = txt.includes('"batch_input_shape"') || txt.includes("batch_input_shape");
    const hasInputShape = txt.includes('"input_shape"') || txt.includes("input_shape");
    return { hasBatchShape, hasBatchInputShape, hasInputShape };
  }

  async function loadAll() {
    clearMessages();
    setAnalyzeEnabled(false);
    els.result.style.display = 'none';
    els.debug.textContent = '';

    log("TFJS version: " + (tf?.version?.tfjs ?? "ok√§nd"));
    log("BUILD: " + BUILD);
    log("MODEL_URL: " + MODEL_URL);
    log("TOKENIZER_URL: " + TOKENIZER_URL);
    log("----");

    try {
      const mj = await fetchText(MODEL_URL);
      log(`model.json status: ${mj.status}`);
      if (!mj.ok) throw new Error(`Hittar inte model.json (${mj.status}). Kontrollera s√∂kv√§gen.`);

      const flags = inspectModelJsonText(mj.text);
      log("model.json inneh√•ller:");
      log(" - batch_shape: " + flags.hasBatchShape);
      log(" - batch_input_shape: " + flags.hasBatchInputShape);
      log(" - input_shape: " + flags.hasInputShape);
      log("----");

      const tj = await fetch(TOKENIZER_URL, { cache: "no-store" });
      log(`tokenizer.json status: ${tj.status}`);
      if (!tj.ok) throw new Error(`Hittar inte tokenizer.json (${tj.status}). Kontrollera s√∂kv√§gen.`);
      tokenizer = await tj.json();

      await tf.setBackend('webgl');
      await tf.ready();
      log("Backend: " + tf.getBackend());

      // Ladda modellen fr√•n URL (inte fr√•n text)
